---
title: "data"
output: github_document
date: "2022-12-14"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(knitr)
library(readxl)
library(corrplot)
library(performance)
library(car)
```


```{r import data}
body_df=read_excel("data/body_density_data.xlsx") %>%
  janitor::clean_names() %>%
  select(-bodyfat_brozek,-body_density,-id)
```

```{r descriptive stat}
# all are continuous data

sum = function(variable){
  tibble(
    mean = mean(variable),
    sd = sd(variable),
    median = median(variable),
    maximum = max(variable),
    minimum = min(variable),
    IQR = IQR(variable)
  )
}

table=map(body_df, sum) %>% 
  bind_rows() %>% 
  mutate(variable = names(body_df)) %>% 
  select(variable,everything()) %>% 
  filter(variable!="id") %>%
  knitr::kable(digits = 2, 
               caption = "Descriptive statistics of continuous variables") 

table
```

```{r correlation}
# check multicollinearity
body_corr=
body_df %>% 
cor() 
png(file="plots/corr.png",type="cairo")
corr=corrplot(cor(body_corr), 
         method = "color", 
         type = "upper",
         addCoef.col = "black", 
         number.cex = 0.6,
         diag = FALSE) 


```

```{r}

#Raw VIF
mult.fit <- lm(bodyfat_siri ~ .,data = body_df)
vif_val <- vif(mult.fit)
name <- str_to_title (names(vif_val))
vifdf <- 
  tibble(variable = name, vif = vif_val) %>%
  mutate(variable = fct_reorder(variable,vif_val))
ggplot(data = vifdf,aes(y = variable, x = vif_val)) +
  geom_col() +
  geom_vline(xintercept = 5,colour="red",linetype = "longdash") +
 theme_bw()


```

```{r}
raw_fit=lm(bodyfat_siri~.,data=body_df)
summary(raw_fit)
```

```{r}
bf_data=body_df %>%
select(-weight,-hip,-chest,-thigh) 
write_csv(bf_data,"data/bf_data.csv")

mult.fit2 <- lm(bodyfat_siri ~ .,data = bf_data)
vif_val <- vif(mult.fit2)
name <- str_to_title (names(vif_val))
vifdf <- 
  tibble(variable = name, vif = vif_val) %>%
  mutate(variable = fct_reorder(variable,vif_val))
ggplot(data = vifdf,aes(y = variable, x = vif_val)) +
  geom_col() +
  geom_vline(xintercept = 5,colour="red",linetype = "longdash") +
 theme_bw()


```

```{r  check outcome variable}
boxplot(body_df$bodyfat_siri,main='Percent body fat using Siri’s equation')

```

```{r}
body_df %>% select(-bodyfat_siri)%>%
  funModeling::plot_num()
```

```{r}
bf_data = read_csv("./data/bf_data.csv") 
bf_predictors = bf_data %>% 
  select(-bodyfat_siri) %>% 
  mutate(age = as.numeric(age),
         height = as.numeric(height),
         neck = as.numeric(neck),
         abdomen = as.numeric(abdomen),
         knee = as.numeric(knee),
         ankle = as.numeric(ankle),
         bicep = as.numeric(bicep),
         forearm = as.numeric(forearm),
         wrist = as.numeric(wrist),
         )

s.t_age <- shapiro.test(bf_predictors$age) 
s.t_height <- shapiro.test(bf_predictors$height) 
s.t_neck <- shapiro.test(bf_predictors$neck) 
s.t_abdomen <- shapiro.test(bf_predictors$abdomen) 
s.t_knee <- shapiro.test(bf_predictors$knee) 
s.t_ankle <- shapiro.test(bf_predictors$ankle) 
s.t_bicep <- shapiro.test(bf_predictors$bicep) 
s.t_forearm <- shapiro.test(bf_predictors$forearm) 
s.t_wrist <- shapiro.test(bf_predictors$wrist) 

rbind(s.t_age, s.t_height, s.t_neck, s.t_abdomen, s.t_knee, s.t_ankle, s.t_bicep, s.t_forearm, s.t_wrist) 
```
The conclusion was confirmed by the results of Shapiro-Wilk normality test, showing that the p-value of "height" is greater than 0.05, the p-values of "wrist" is slightly greater than 0.05, and the p-values of other predictors are smaller than 0.05. Among which, the p-values of "bicep" are "wrist" are close to 0.05 from the left.
Therefore, I tried exponential transformations on the variables "height".
```{r}
h_trans = bf_predictors %>% 
  select(2) %>%
  exp()
hist(h_trans[,1], main = paste("Hist. of", "height", sep = " "), xlab = "height")
shapiro.test(h_trans$height) 
```
Although the converted p-value is less than 0.05, the normality of the distribution shown in the histogram is weakened, so we still use the untransformed value of "height" to participate in the subsequent calculation. Use automatic procedures to find a ‘best subset’of the full model. Present the results and comment on the following:
```{r}
step.fit = lm(bodyfat_siri ~ ., data = bf_data)
step(step.fit, direction = "both")
```
The model we obtained by Stepwise Regression is bodyfat_siri = 5.60733 + 0.07543 * age - 0.28925 * height - 0.58137 * neck + 0.77409 * abdomen + 0.51691 * forearm + -1.85861 * wrist.

```{r}

```

