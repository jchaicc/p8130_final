---
title: "data"
output: github_document
date: "2022-12-14"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(knitr)
library(readxl)
library(corrplot)
library(performance)
library(car)
library(interactions)
library(caret)
library(MASS)
```


```{r import data}
body_df=read_excel("data/body_density_data.xlsx") %>%
  janitor::clean_names() %>%
  select(-bodyfat_brozek,-body_density,-id)
```

```{r descriptive stat}
# all are continuous data

sum = function(variable){
  tibble(
    mean = mean(variable),
    sd = sd(variable),
    median = median(variable),
    maximum = max(variable),
    minimum = min(variable),
    IQR = IQR(variable)
  )
}

table=map(body_df, sum) %>% 
  bind_rows() %>% 
  mutate(variable = names(body_df)) %>% 
  select(variable,everything()) %>% 
  filter(variable!="id") %>%
  knitr::kable(digits = 2, 
               caption = "Descriptive statistics of continuous variables") 

table
```

```{r correlation}
# check multicollinearity
body_corr=
body_df %>% 
cor() 
png(file="plots/corr.png",type="cairo")
corr=corrplot(cor(body_corr), 
         method = "color", 
         type = "upper",
         addCoef.col = "black", 
         number.cex = 0.6,
         diag = FALSE) 


```

```{r}

#Raw VIF
mult.fit <- lm(bodyfat_siri ~ .,data = body_df)
vif_val <- vif(mult.fit)
name <- str_to_title (names(vif_val))
vifdf <- 
  tibble(variable = name, vif = vif_val) %>%
  mutate(variable = fct_reorder(variable,vif_val))
ggplot(data = vifdf,aes(y = variable, x = vif_val)) +
  geom_col() +
  geom_vline(xintercept = 5,colour="red",linetype = "longdash") +
 theme_bw()


```

```{r}
raw_fit=lm(bodyfat_siri~.,data=body_df)
summary(raw_fit)
```

```{r}
bf_data=body_df %>%
select(-weight,-hip,-chest,-thigh) 
write_csv(bf_data,"data/bf_data.csv")

mult.fit2 <- lm(bodyfat_siri ~ .,data = bf_data)
vif_val <- vif(mult.fit2)
name <- str_to_title (names(vif_val))
vifdf <- 
  tibble(variable = name, vif = vif_val) %>%
  mutate(variable = fct_reorder(variable,vif_val))
ggplot(data = vifdf,aes(y = variable, x = vif_val)) +
  geom_col() +
  geom_vline(xintercept = 5,colour="red",linetype = "longdash") +
 theme_bw()


```

```{r  check outcome variable}
boxplot(body_df$bodyfat_siri,main='Percent body fat using Siri’s equation')

```

```{r}
body_df %>% select(-bodyfat_siri)%>%
  funModeling::plot_num()
```

```{r}
bf_data = read_csv("./data/bf_data.csv") 
bf_predictors = bf_data %>% 
  select(-bodyfat_siri) %>% 
  mutate(age = as.numeric(age),
         height = as.numeric(height),
         neck = as.numeric(neck),
         abdomen = as.numeric(abdomen),
         knee = as.numeric(knee),
         ankle = as.numeric(ankle),
         bicep = as.numeric(bicep),
         forearm = as.numeric(forearm),
         wrist = as.numeric(wrist),
         )

s.t_age <- shapiro.test(bf_predictors$age) 
s.t_height <- shapiro.test(bf_predictors$height) 
s.t_neck <- shapiro.test(bf_predictors$neck) 
s.t_abdomen <- shapiro.test(bf_predictors$abdomen) 
s.t_knee <- shapiro.test(bf_predictors$knee) 
s.t_ankle <- shapiro.test(bf_predictors$ankle) 
s.t_bicep <- shapiro.test(bf_predictors$bicep) 
s.t_forearm <- shapiro.test(bf_predictors$forearm) 
s.t_wrist <- shapiro.test(bf_predictors$wrist) 

rbind(s.t_age, s.t_height, s.t_neck, s.t_abdomen, s.t_knee, s.t_ankle, s.t_bicep, s.t_forearm, s.t_wrist) 
```

```{r}
h_trans = bf_predictors %>% 
  select(2) %>%
  exp()
hist(h_trans[,1], main = paste("Hist. of", "height", sep = " "), xlab = "height")
shapiro.test(h_trans$height) 
```

```{r}
step.fit = lm(bodyfat_siri ~ ., data = bf_data)
step(step.fit, direction = "both")
```
The model we obtained by Stepwise Regression is bodyfat_siri = 5.60733 + 0.07543 * age - 0.28925 * height - 0.58137 * neck + 0.77409 * abdomen + 0.51691 * forearm + -1.85861 * wrist.
Next, we operated diagnostics for checking the adequacy of the regression model. Firstly, we assessed model assumptions by the following diagnostic plots.
```{r}
fit1 = lm(bodyfat_siri ~ age + height + neck + abdomen + forearm + 
    wrist, data = bf_data)
par(mfrow = c(2,2))
plot(fit1)
```
As shown in the Residuals vs Fitted plot, residual values bounce around 0 and residuals form a generally horizontal (linear) ‘band’ around zero, showing no unequal error variance (heteroscedasticity). *** stands out from the random pattern and causes the plot to shift downward, which makes it a potential outlier.
According to the QQ plot, the plot is almost straight, showing a nice normality. *** stands out again from the random pattern.
The Scale-location plot is almost a horizontal line with equally spread points, confirming the assumption of equal variance.
In the Residuals vs Leverage plot, *** appears to be an outlying value at the upper right corner, being close to the edge at the Cook’s distance.So our model maybe couldn't explain *** very well.

```{r}

inter2=update(fit1, .~.+forearm*height)
interact_plot(inter2,pred = forearm, modx = height) 

inter3=update(fit1, .~.+neck*height)
interact_plot(inter3,pred = neck, modx = height) 

inter4=update(fit1, .~.+abdomen*knee)
interact_plot(inter4,pred = abdomen, modx = knee) 

anova(fit1,inter2)
anova(fit1,inter3)

anova(fit1,inter4)


```

```{r cv}

model13 = train(bodyfat_siri ~ age + height + neck + abdomen + forearm + wrist + height*neck ,
                   data = bf_data,
                   trControl = train,
                   method = 'lm',
                   na.action = na.pass)
model13$finalModel
print(model13)

model14 = train(bodyfat_siri ~ age + height + neck + abdomen + forearm + wrist + abdomen*knee ,
                   data = bf_data,
                   trControl = train,
                   method = 'lm',
                   na.action = na.pass)
model14$finalModel
print(model14)

```

```{r}
fit_adj4 = lm(formula = bodyfat_siri ~ age + height + neck + abdomen + forearm + wrist + abdomen*knee, data = bf_data)
summary(fit_adj4)
plot(fit_adj4)

plot(fit_adj4, which = 4)

surgOut = bf_data[-c(39,192,250),]
fit_adj4_without=lm(formula = bodyfat_siri ~ age + height + neck + abdomen + forearm + wrist + abdomen*knee,data=surgOut)
plot(fit_adj4_without)
summary(fit_adj4_without)
```